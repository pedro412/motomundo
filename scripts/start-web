#!/bin/bash
set -euo pipefail

echo "🚀 Starting MotoMundo web server..."

RAW_PORT="${PORT:-}"
if [ -z "$RAW_PORT" ]; then
    PORT=8000
else
    PORT="$(echo "$RAW_PORT" | tr -cd '0-9')"
fi
if ! [[ "$PORT" =~ ^[0-9]+$ ]]; then
    echo "❌ Invalid PORT '$RAW_PORT' -> '$PORT', using 8000" >&2
    PORT=8000
fi
echo "🔧 Using port: $PORT"

GUNICORN_CMD="gunicorn"
if ! command -v gunicorn >/dev/null 2>&1; then
    if [ -f ".venv/bin/gunicorn" ]; then
        GUNICORN_CMD=".venv/bin/gunicorn"
    fi
fi
echo "🎯 Using gunicorn: $GUNICORN_CMD"

set -x
exec $GUNICORN_CMD motomundo.wsgi:application \
    --bind 0.0.0.0:"$PORT" \
    --workers 2 \
    --timeout 120 \
    --keep-alive 5 \
    --max-requests 1000 \
    --preload \
    --access-logfile - \
    --error-logfile -
