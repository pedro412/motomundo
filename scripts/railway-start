#!/bin/bash

# Add this to your startup script before the port parsing
echo "🔍 Raw environment variables:"
printenv | grep -i port || true

set -euo pipefail

echo "🚀 Starting MotoMundo on Railway..."

# Show a subset of environment for debugging (mask obvious secrets)
echo "🔍 Environment snapshot (filtered):"
env | grep -E '(^PORT=|RAILWAY_|DJANGO_SETTINGS_MODULE)' | sed 's/SECRET_KEY=.*/SECRET_KEY=***MASKED***/'

# Capture raw values
RAW_PORT="${PORT:-}"
RAW_TCP_PROXY="${RAILWAY_TCP_PROXY_PORT:-}"
echo "🧪 Raw PORT='${RAW_PORT}'  RAILWAY_TCP_PROXY_PORT='${RAW_TCP_PROXY}'"
printf '🔡 PORT raw bytes (hex): '; printf '%s' "${RAW_PORT}" | od -An -t x1 || true

# Fallback: if PORT empty but RAILWAY_TCP_PROXY_PORT present, use it
if [ -z "$RAW_PORT" ] && [ -n "$RAW_TCP_PROXY" ]; then
	echo "↪️ Using RAILWAY_TCP_PROXY_PORT as PORT fallback"
	RAW_PORT="$RAW_TCP_PROXY"
fi

if [ -z "${RAW_PORT}" ]; then
	echo "ℹ️ No PORT provided; defaulting to 8000 (may mean Railway did not inject yet or custom var missing).";
	PORT=8000
else
	# Strip non-digits
	SANITIZED="$(echo "$RAW_PORT" | tr -cd '0-9')"
	if [ -z "$SANITIZED" ]; then
		echo "❌ PORT '$RAW_PORT' became empty after removing non-digits; defaulting to 8000" >&2
		PORT=8000
	else
		PORT="$SANITIZED"
	fi
fi

if ! [[ "$PORT" =~ ^[0-9]+$ ]]; then
	echo "❌ PORT value '$PORT' still invalid; forcing 8000" >&2
	PORT=8000
fi

if [ "$PORT" -lt 1 ] || [ "$PORT" -gt 65535 ]; then
	echo "❌ PORT $PORT out of range; forcing 8000" >&2
	PORT=8000
fi

echo "🔧 Final bind port: $PORT"

GUNICORN_CMD="gunicorn"
if ! command -v gunicorn >/dev/null 2>&1; then
	if [ -f "/app/.venv/bin/gunicorn" ]; then
		GUNICORN_CMD="/app/.venv/bin/gunicorn"
	elif [ -f ".venv/bin/gunicorn" ]; then
		GUNICORN_CMD=".venv/bin/gunicorn"
	else
		echo "❌ gunicorn not found in PATH" >&2
		exit 1
	fi
fi
echo "🎯 Using gunicorn executable: $(which $GUNICORN_CMD || echo $GUNICORN_CMD)"

set -x
exec $GUNICORN_CMD motomundo.wsgi:application \
	--bind 0.0.0.0:"$PORT" \
	--workers 2 \
	--timeout 120 \
	--keep-alive 5 \
	--max-requests 1000 \
	--preload \
	--access-logfile - \
	--error-logfile -
